<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Часы + Погода</title>
    <!-- Подключаем шрифт ДО CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .container {
            position: static;
            transform: none;
            cursor: auto;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <div class="nav-tabs">
        <a href="/" class="nav-btn active" id="nav-home">Погода сейчас</a>
        <a href="/forecast" class="nav-btn" id="nav-forecast">Прогноз на неделю</a>
    </div>

    <!-- Анимация загрузки -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-title">Загрузка погоды...</div>
            <div class="loader-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="container" id="container">
        <div class="clock-section">
            <div class="time" id="time">00:00:00</div>
            <div class="date-day">
                <span id="date">00-00-0000</span>
                <span id="day">Понедельник</span>
            </div>
        </div>

        <div class="weather-section" id="weather-section">
            <div class="weather-header">
                <img id="weather-icon" src="{{ url_for('static', filename='icons/animated/01d.gif') }}" alt="Погода">
                <div class="temp-main" id="temp">--°C</div>
            </div>

            <div class="weather-details">
                <div class="city" id="city">Загрузка...</div>
                <div class="desc" id="desc">—</div>

                <div class="info-grid">
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/mindset.png') }}" alt="Ощущается" class="icon-feels">
                        <span>Ощущается:</span>
                        <strong id="feels_like">--°C</strong>
                    </div>
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/humidity.png') }}" alt="Влажность" class="icon-humidity">
                        <span>Влажность:</span>
                        <strong id="humidity">--%</strong>
                    </div>
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/resilience.png') }}" alt="Давление" class="icon-pressure">
                        <span>Давление:</span>
                        <strong id="pressure">-- мм рт. ст.</strong>
                    </div>
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/windy.png') }}" alt="Ветер" class="icon-wind">
                        <span>Ветер:</span>
                        <strong id="wind">-- м/с</strong>
                    </div>
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/animated/sunrise.gif') }}" alt="Восход" class="icon-sunrise">
                        <span>Восход:</span>
                        <strong id="sunrise">--:--</strong>
                    </div>
                    <div class="item">
                        <img src="{{ url_for('static', filename='icons/animated/sunset.gif') }}" alt="Закат" class="icon-sunset">
                        <span>Закат:</span>
                        <strong id="sunset">--:--</strong>
                    </div>
                </div>
            </div>

            <!-- Индикатор обновления -->
            <div class="last-updated" id="last-updated">Обновлено: --:--:--</div>
        </div>
    </div>

    <script>
        // --- 1. Скрытие лоадера ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                }, 500);
            }, 800);

            // Показать контент
            document.getElementById('container').classList.add('fade-in');
        });

        // --- 2. Обновление времени ---
        function updateTime() {
            const now = new Date();
            const days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];
            const months = ["января", "февраля", "марта", "апреля", "мая", "июня",
                            "июля", "августа", "сентября", "октября", "ноября", "декабря"];

            document.getElementById('time').textContent = now.toLocaleTimeString('ru-RU', { hour12: false });
            document.getElementById('date').textContent = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('day').textContent = days[now.getDay()];
        }

        // --- 3. Переключение темы (ночь/день) — ИСПРАВЛЕНО ---
        function updateTheme() {
            const hour = new Date().getHours();
            if (hour >= 20 || hour < 7) {  // Ночь: с 20:00 до 07:00
                document.body.classList.add('night');
            } else {
                document.body.classList.remove('night');
            }
        }

        // --- 4. Обновление погоды с анимацией ---
        function updateWeather() {
            const weatherSection = document.getElementById('weather-section');
            weatherSection.classList.add('updating');

            // Время запроса (до fetch)
            const requestTime = new Date();

            fetch('/api/weather')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.warn("API вернул ошибку:", data.error);
                        return;
                    }

                    document.getElementById('city').textContent = data.city;
                    document.getElementById('temp').textContent = `${Math.round(data.temp)}°C`;
                    document.getElementById('feels_like').textContent = `${Math.round(data.feels_like)}°C`;
                    document.getElementById('humidity').textContent = `${data.humidity}%`;
                    document.getElementById('pressure').textContent = `${data.pressure} мм рт. ст.`;
                    document.getElementById('wind').textContent = data.wind;
                    document.getElementById('sunrise').textContent = data.sunrise;
                    document.getElementById('sunset').textContent = data.sunset;
                    document.getElementById('desc').textContent = data.desc;
                    document.getElementById('weather-icon').src = `/static/icons/animated/${data.icon}.gif`;

                    // Обновляем время
                    document.getElementById('last-updated').textContent =
                        `Обновлено: ${requestTime.toLocaleTimeString('ru-RU', { hour12: false })}`;

                    // Анимация обновления
                    weatherSection.classList.remove('updating');
                    weatherSection.classList.add('updated');
                    setTimeout(() => {
                        weatherSection.classList.remove('updated');
                    }, 600);
                })
                .catch(err => {
                    console.error("Ошибка загрузки погоды:", err);
                    document.getElementById('city').textContent = 'Ошибка';

                    document.getElementById('last-updated').textContent =
                        `Обновлено: ${requestTime.toLocaleTimeString('ru-RU', { hour12: false })}`;
                })
                .finally(() => {
                    weatherSection.classList.remove('updating');
                });
        }

        // --- Запуск ---
        setInterval(updateTime, 1000);
        setInterval(updateTheme, 60000);
        setInterval(updateWeather, 900000); // каждые 15 минут

        updateTime();
        updateTheme();
        updateWeather();
    </script>
</body>
</html>